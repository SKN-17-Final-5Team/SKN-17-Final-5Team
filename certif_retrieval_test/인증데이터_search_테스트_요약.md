# í•´ì™¸ ì¸ì¦ ë°ì´í„° Retrieval ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê³¼ì • ìš”ì•½

ì‘ì—… ì§„í–‰ì: í•œí›ˆ

---

### 1ë‹¨ê³„: ë°ì´í„° ì¤€ë¹„ ë° ë³€í™˜
**ëª©í‘œ**: CSV í˜•ì‹ì˜ ì¸ì¦ ë°ì´í„°ë¥¼ RAG ì‹œìŠ¤í…œìš© JSONL í˜•ì‹ìœ¼ë¡œ ë³€í™˜

**ì‘ì—… ë‚´ìš©**:
- ì›ë³¸ CSV íŒŒì¼ì—ì„œ ì¸ì¦ ì •ë³´ ë¡œë“œ
- ê° ì¸ì¦ ë°ì´í„°ì— ëŒ€í•´:
  - ê³ ìœ  ID ë¶€ì—¬
  - ë©”íƒ€ë°ì´í„° ì¶”ì¶œ (êµ­ê°€, ì¹´í…Œê³ ë¦¬, ì¸ì¦ êµ¬ë¶„, ëŒ€í‘œ ì¸ì¦ëª… ë“±)
  - ì „ì²´ í…ìŠ¤íŠ¸ í•„ë“œ ê²°í•© (cert_name + metadata + cert_subject)
  - ìë™ ìš”ì•½ ìƒì„± (cert_subjectì˜ ì²« 150ì)
- JSONL íŒŒì¼ë¡œ ì €ì¥ (`output/certifications.jsonl`)

**ì£¼ìš” íŒŒì¼**: `certif_doc_convert.py`

**ê²°ê³¼**: ì´ 92ê°œ ì¸ì¦ ë¬¸ì„œ ë³€í™˜ ì™„ë£Œ

---

### 2ë‹¨ê³„: RAG ì‹œìŠ¤í…œ êµ¬ì¶•
**ëª©í‘œ**: Qdrant ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤ë¥¼ í™œìš©í•œ ì˜ë¯¸ ê¸°ë°˜ ê²€ìƒ‰ ì‹œìŠ¤í…œ êµ¬í˜„

**ê¸°ìˆ  ìŠ¤íƒ**:
- **ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤**: Qdrant Cloud
- **ì„ë² ë”© ëª¨ë¸**:
  - OpenAI `text-embedding-3-large` (3072ì°¨ì›)
  - HuggingFace `jhgan/ko-sroberta-multitask` (768ì°¨ì›)

**í•µì‹¬ ê¸°ëŠ¥ êµ¬í˜„**:
1. **ì„ë² ë”© ìƒì„±**: í…ìŠ¤íŠ¸ë¥¼ ê³ ì°¨ì› ë²¡í„°ë¡œ ë³€í™˜
2. **ì²­í‚¹(Chunking)**: ê¸´ ë¬¸ì„œë¥¼ ê²¹ì¹¨(overlap)ì„ í¬í•¨í•˜ì—¬ ë¶„í• 
3. **ë²¡í„° ì¸ë±ì‹±**: Qdrant Cloudì— ì„ë² ë”© ë²¡í„° ì €ì¥
4. **ì˜ë¯¸ ê¸°ë°˜ ê²€ìƒ‰**: ì½”ì‚¬ì¸ ìœ ì‚¬ë„(Cosine Similarity)ë¥¼ ì‚¬ìš©í•œ ê²€ìƒ‰
5. **í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰**: ì˜ë¯¸ ê²€ìƒ‰ + BM25 í‚¤ì›Œë“œ ê²€ìƒ‰ ê²°í•©

**ì£¼ìš” íŒŒì¼**: `qdrant_rag.py`

**ì£¼ìš” ì„¤ì •**:
```python
- ì»¬ë ‰ì…˜ ì´ë¦„: "certifications"
- ì„ë² ë”© í”„ë¡œë°”ì´ë”: OpenAI / HuggingFace ì„ íƒ ê°€ëŠ¥
- ì²­í‚¹: ë¹„í™œì„±í™” ë˜ëŠ” 500/1000/2000ì ë‹¨ìœ„ ì„¤ì • ê°€ëŠ¥
- í…ìŠ¤íŠ¸ í•„ë“œ: auto_summary ë˜ëŠ” ì „ì²´ cert_subject ì„ íƒ
```

---

### 3ë‹¨ê³„: ê²€ìƒ‰ ì„±ëŠ¥ í‰ê°€ ì‹œìŠ¤í…œ êµ¬ì¶•
**ëª©í‘œ**: ë‹¤ì–‘í•œ ì„¤ì •ì˜ ê²€ìƒ‰ ì„±ëŠ¥ì„ ì •ëŸ‰ì ìœ¼ë¡œ ì¸¡ì • ë° ë¹„êµ

**í‰ê°€ ë°ì´í„°ì…‹**:
- ì´ 20ê°œì˜ Q&A ìŒ ìƒì„± (`qa_dataset.json`)
- ë‚œì´ë„ë³„ ë¶„í¬:
  - Easy: 5ê°œ (ì§ì ‘ì ì¸ êµ­ê°€ + ì¹´í…Œê³ ë¦¬ ì§ˆë¬¸)
  - Medium: 10ê°œ (ê¸°ìˆ  ì‚¬ì–‘ ì§ˆë¬¸)
  - Hard: 5ê°œ (íŠ¹ì • ê¸°ìˆ  ìš©ì–´ ì§ˆë¬¸ - "510(k)", "CNS 4797" ë“±)

**í‰ê°€ ì§€í‘œ**:
1. **Recall@K**: ìƒìœ„ Kê°œ ê²°ê³¼ì— ì •ë‹µì´ í¬í•¨ë˜ëŠ” ë¹„ìœ¨
   - Recall@1: 1ë“±ì— ì •ë‹µ
   - Recall@3: ìƒìœ„ 3ê°œì— ì •ë‹µ
   - Recall@5: ìƒìœ„ 5ê°œì— ì •ë‹µ
2. **MRR (Mean Reciprocal Rank)**: ì •ë‹µì´ ë‚˜íƒ€ë‚˜ëŠ” ìˆœìœ„ì˜ ì—­ìˆ˜ í‰ê· 

**ì£¼ìš” íŒŒì¼**: `evaluate_retrieval.py`, `qa_dataset.json`

---

### 4ë‹¨ê³„: ì„¤ì • ìµœì í™” ì‹¤í—˜
**ëª©í‘œ**: ìµœê³  ì„±ëŠ¥ì„ ë‚´ëŠ” ì„¤ì • ì¡°í•© ì°¾ê¸°

**ì‹¤í—˜í•œ ì„¤ì • ì¡°í•©** (ì´ 10ê°€ì§€):
1. ì²­í‚¹ í¬ê¸° ë¹„êµ: None, 500, 1000, 2000ì
2. ì„ë² ë”© ëª¨ë¸ ë¹„êµ: OpenAI vs HuggingFace
3. í…ìŠ¤íŠ¸ í•„ë“œ ë¹„êµ: auto_summary vs ì „ì²´ cert_subject
4. ê²€ìƒ‰ ë°©ì‹ ë¹„êµ: ì˜ë¯¸ ê²€ìƒ‰ vs í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰

**ì‹¤í—˜ ê²°ê³¼ ë¶„ì„**:

| ì„¤ì • | Recall@1 | Recall@3 | Recall@5 | MRR |
|------|----------|----------|----------|-----|
| **ìš”ì•½ í…ìŠ¤íŠ¸ + OpenAI + ì²­í‚¹ ì—†ìŒ** | 30% | 45% | 70% | 0.430 |
| **ìš”ì•½ í…ìŠ¤íŠ¸ + OpenAI + ì²­í¬ 1000** | 30% | 65% | 75% | 0.499 |
| **ì „ì²´ í…ìŠ¤íŠ¸ + OpenAI + ì²­í‚¹ ì—†ìŒ** | **55%** | **80%** | 90% | **0.688** |
| **ì „ì²´ í…ìŠ¤íŠ¸ + OpenAI + ì²­í¬ 1000** | 50% | **85%** | **90%** | 0.668 |
| **HuggingFace ëª¨ë¸ (ëª¨ë“  ì„¤ì •)** | 15% | 20% | 30% | 0.227 |
| **í•˜ì´ë¸Œë¦¬ë“œ (ì˜ë¯¸+BM25)** | 30-45% | 70-75% | 85-90% | 0.544-0.610 |

**í•µì‹¬ ë°œê²¬ ì‚¬í•­**:

1. **ì „ì²´ í…ìŠ¤íŠ¸ >> ìš”ì•½**:
   - ì „ì²´ cert_subject ì‚¬ìš© ì‹œ Recall@3: 80-85%
   - auto_summary ì‚¬ìš© ì‹œ Recall@3: 45-65%
   - **ê°œì„ ìœ¨: +31%~+77%**
   - ì´ìœ : ê¸°ìˆ  ìš©ì–´("510(k)", "Class II" ë“±)ê°€ ìš”ì•½ì— ëˆ„ë½ë¨

2. **OpenAI >> HuggingFace**:
   - OpenAI Recall@3: 80-85%
   - HuggingFace Recall@3: 20%
   - **ì„±ëŠ¥ ì°¨ì´: 4ë°°**
   - ì´ìœ : OpenAIëŠ” 3072ì°¨ì›ìœ¼ë¡œ ë” í’ë¶€í•œ ì˜ë¯¸ í‘œí˜„, ë²•ê·œ/ê¸°ìˆ  ë¬¸ì„œ í•™ìŠµ ìš°ìˆ˜

3. **ì²­í‚¹ íš¨ê³¼**:
   - ì „ì²´ í…ìŠ¤íŠ¸: ì²­í¬ 1000ì ì‚¬ìš© ì‹œ Recall@3 80% â†’ 85% (+6%)
   - ìš”ì•½ í…ìŠ¤íŠ¸: ì²­í‚¹ íš¨ê³¼ ë¯¸ë¯¸

4. **í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ì˜ ì˜ˆìƒ ì™¸ ê²°ê³¼**:
   - ì˜ë¯¸ ê²€ìƒ‰ë§Œ: Recall@3 85%
   - í•˜ì´ë¸Œë¦¬ë“œ: Recall@3 75% (-10%p)
   - **ê¸°ëŒ€ì™€ ë‹¬ë¦¬ ì„±ëŠ¥ í•˜ë½**
   - ì¶”ì • ì›ì¸:
     - ë‹¨ìˆœí•œ í•œê¸€ í† í°í™”ì˜ í•œê³„
     - BM25ì™€ ì˜ë¯¸ ê²€ìƒ‰ì˜ ë¬¸ì„œ-ì²­í¬ ë ˆë²¨ ë¶ˆì¼ì¹˜
     - RRF ê°€ì¤‘ì¹˜ ë¶€ì í•© (70:30)

---

## ğŸ† ìµœì¢… ê¶Œì¥ ì„¤ì •

**í”„ë¡œë•ì…˜ ì‚¬ìš© ê¶Œì¥ ì„¤ì •**:
```python
{
    "name": "chunk_1000_openai_fulltext",
    "collection_name": "certifications_chunk_1000_openai_fulltext",
    "chunk_size": 1000,
    "chunk_overlap": 100,
    "embedding_provider": "openai",
    "embedding_model": "text-embedding-3-large",
    "text_field": "full",  # ì „ì²´ cert_subject ì‚¬ìš©
    "use_hybrid": False     # ì˜ë¯¸ ê²€ìƒ‰ë§Œ ì‚¬ìš©
}
```

**ìµœì¢… ì„±ëŠ¥**:
- âœ… **Recall@1: 50%** (2ê°œ ì¤‘ 1ê°œëŠ” 1ë“±ìœ¼ë¡œ)
- âœ… **Recall@3: 85%** (20ê°œ ì¤‘ 17ê°œê°€ ìƒìœ„ 3ê°œ ì•ˆì— í¬í•¨)
- âœ… **Recall@5: 90%** (20ê°œ ì¤‘ 18ê°œê°€ ìƒìœ„ 5ê°œ ì•ˆì— í¬í•¨)
- âœ… **MRR: 0.668** (í‰ê·  ìˆœìœ„ 1.5ë“±)

---

## ğŸ“ í”„ë¡œì íŠ¸ íŒŒì¼ êµ¬ì¡°

```
certif_retrieval_test/
â”œâ”€â”€ certif_doc_convert.py          # CSV â†’ JSONL ë³€í™˜ ìŠ¤í¬ë¦½íŠ¸
â”œâ”€â”€ qdrant_rag.py                  # RAG ì‹œìŠ¤í…œ í•µì‹¬ ëª¨ë“ˆ
â”œâ”€â”€ evaluate_retrieval.py          # ì„±ëŠ¥ í‰ê°€ ìŠ¤í¬ë¦½íŠ¸
â”œâ”€â”€ test_retrieval.py              # ê°„ë‹¨í•œ ê²€ìƒ‰ í…ŒìŠ¤íŠ¸
â”œâ”€â”€ qa_dataset.json                # í‰ê°€ìš© 20ê°œ Q&A ì„¸íŠ¸
â”œâ”€â”€ evaluation_results_*.json      # í‰ê°€ ê²°ê³¼ íŒŒì¼ë“¤
â”œâ”€â”€ requirements.txt               # ì˜ì¡´ì„± íŒ¨í‚¤ì§€ ëª©ë¡
â”œâ”€â”€ output/
â”‚   â””â”€â”€ certifications.jsonl       # ë³€í™˜ëœ ì¸ì¦ ë°ì´í„° (92ê°œ)
â””â”€â”€ README.md                      # í”„ë¡œì íŠ¸ ì„¤ëª…ì„œ
```

---

## ê¸°ìˆ ì  êµ¬í˜„ ì„¸ë¶€ì‚¬í•­

### 1. ì„ë² ë”© ìƒì„±
```python
# OpenAI ì„ë² ë”© (3072ì°¨ì›)
response = openai_client.embeddings.create(
    model="text-embedding-3-large",
    input=text
)
vector = response.data[0].embedding
```

### 2. ì²­í‚¹ ì „ëµ
```python
# 1000ì ë‹¨ìœ„, 100ì ê²¹ì¹¨
chunk_size = 1000
chunk_overlap = 100

# ìŠ¬ë¼ì´ë”© ìœˆë„ìš° ë°©ì‹
for start in range(0, len(text), chunk_size - chunk_overlap):
    chunk = text[start:start + chunk_size]
    chunks.append(chunk)
```

### 3. ì˜ë¯¸ ê²€ìƒ‰
```python
# ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ì‚¬ìš©
similarity = cosine_similarity(query_vector, document_vectors)
# Qdrantì—ì„œ ìë™ìœ¼ë¡œ ì²˜ë¦¬
results = client.search(
    collection_name="certifications",
    query_vector=query_vector,
    limit=5
)
```

### 4. í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ (RRF)
```python
# Reciprocal Rank Fusion
k = 60  # RRF ìƒìˆ˜
semantic_score = 0.7 / (k + semantic_rank)
bm25_score = 0.3 / (k + bm25_rank)
final_score = semantic_score + bm25_score
```

---

## ì£¼ìš” ë‚´ìš©

1. **ì˜ë¯¸ ê²€ìƒ‰ í¼í¬ë¨¼ìŠ¤**: í‚¤ì›Œë“œ ë§¤ì¹­ì´ ì•„ë‹Œ ì˜ë¯¸ ê¸°ë°˜ ê²€ìƒ‰ìœ¼ë¡œ "ì˜ë£Œê¸°ê¸° ì¸ì¦"ê³¼ "FDA ìŠ¹ì¸"ì„ ì—°ê²° ê°€ëŠ¥

2. **ì»¨í…ìŠ¤íŠ¸ì˜ ì¤‘ìš”ì„±**: ì „ì²´ í…ìŠ¤íŠ¸ê°€ ìš”ì•½ë³´ë‹¤ ê¸°ìˆ  ë¬¸ì„œì—ì„œ ì••ë„ì ìœ¼ë¡œ ìš°ìˆ˜

4. **í•˜ì´ë¸Œë¦¬ë“œì˜ í•¨ì •**: í•­ìƒ ë” ì¢‹ì€ ê²ƒì€ ì•„ë‹˜, êµ¬í˜„ ì„¸ë¶€ì‚¬í•­ì´ ì¤‘ìš”

5. **í‰ê°€ ì¤‘ìš”ì„±**: Recall@K, MRR ê°™ì€ ì •ëŸ‰ì  ì§€í‘œë¡œ ê°ê´€ì  ë¹„êµ ê°€ëŠ¥

---

## ë¹„ìš© ê³ ë ¤ì‚¬í•­

**OpenAI ì„ë² ë”© ë¹„ìš©** (`text-embedding-3-large`):
- ê°€ê²©: $0.13 per 1M tokens
- 92ê°œ ë¬¸ì„œ (ì²­í¬ 1000ì):
  - ì•½ 150~200 ì²­í¬ ìƒì„±
  - ì´ í† í°: ~50K tokens
  - **ì´ˆê¸° ì¸ë±ì‹± ë¹„ìš©**: ~$0.007 (ì•½ 10ì›)
- ê²€ìƒ‰ ì¿¼ë¦¬ë‹¹:
  - ~10 tokens
  - **ì¿¼ë¦¬ë‹¹ ë¹„ìš©**: ~$0.000001 (ë¬´ì‹œí•  ìˆ˜ì¤€)

**Qdrant Cloud**:
- Free tier: 1GB ì €ì¥, ì¶©ë¶„í•¨
- 3072ì°¨ì› Ã— 200 ë²¡í„° = ì•½ 2.4MB

**ê²°ë¡ **: ë§¤ìš° ì €ë ´í•œ ë¹„ìš©ìœ¼ë¡œ ê³ í’ˆì§ˆ ê²€ìƒ‰ ì‹œìŠ¤í…œ êµ¬ì¶• ê°€ëŠ¥

---

## í™˜ê²½ ì„¤ì • í•„ìš” ì‚¬í•­

`.env` íŒŒì¼ì— ë‹¤ìŒ í‚¤ ì„¤ì • í•„ìš”:
```bash
# OpenAI (í•„ìˆ˜ - ìµœê³  ì„±ëŠ¥)
OPENAI_API_KEY=sk-...

# Qdrant Cloud (í•„ìˆ˜)
QDRANT_URL=https://...
QDRANT_API_KEY=...

# HuggingFace (ì„ íƒ - ì„±ëŠ¥ ë‚®ìŒ)
HF_TOKEN=hf_...
```

---

## í‰ê°€ ê²°ê³¼ íŒŒì¼

- `evaluation_results_20251114_125102.json`: ì˜ë¯¸ ê²€ìƒ‰ ì „ì²´ ë¹„êµ
- `evaluation_results_20251114_142751.json`: í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ í¬í•¨ ìµœì¢… ë¹„êµ

---


**ì‘ì„±ì¼**: 2025ë…„ 11ì›” 14ì¼  
**ìµœì¢… ì„±ëŠ¥**: Recall@3 85%, Recall@5 90%  
**ê¶Œì¥ ì„¤ì •**: OpenAI text-embedding-3-large + ì „ì²´ í…ìŠ¤íŠ¸ + ì²­í¬ 1000ì
